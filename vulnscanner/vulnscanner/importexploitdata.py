import psycopg2
import logging
from vulnscanner.config import config as dbConfig

importExploitDataLogger = logging.getLogger(__name__)

class ImportExploitData():
    def __init__(self, cveNumber=None, referenceSource=None, descriptionValue=None, baseScore=None, serviceId=None):
        self.cveNumber = cveNumber
        self.referenceSource = referenceSource
        self.descriptionValue = descriptionValue
        self.baseScore = baseScore
        self.serviceId = serviceId
        self.dbConnection = None
        self.query = None
        self.connectToDatabase()

    def connectToDatabase(self):
        try:
            dbParams = dbConfig()
            importExploitDataLogger.info("Connecting to the PostgreSQL database")
            self.dbConnection = psycopg2.connect(**dbParams)
            self.dbCursor = self.dbConnection.cursor()
            self.importExploitData()
        except (Exception, psycopg2.DatabaseError) as error:
            importExploitDataLogger.info("Connection error: {}".format(error))
        finally:
            if self.dbConnection is not None:
                self.dbConnection.close()  # move to another function
                importExploitDataLogger.info("Database connection closed.")
        
    def importExploitData(self):
        self.query = self.formAnExploitQuery
        self.dbCursor.execute(self.query)
        self.query = self.formAnExploitServiceQuery
        self.dbCursor.execute(self.query)

    def formAnExploitQuery(self):
        return "INSERT INTO exploit VALUES ('{}', '{}', '{}', '{}')".format(self.cveNumber, self.baseScore, self.referenceSource, self.descriptionValue)

    def formAnExploitServiceQuery(self):
        return "INSERT INTO serviceexploit VALUES ('{}', '{}')".format(self.serviceId, self.cveNumber)